# vllama reverse proxy configuration for Caddy
# Place in /etc/caddy/Caddyfile

llm.example.com {
    # Automatic HTTPS with Let's Encrypt
    # Caddy handles certificates automatically

    # Rate limiting (10 requests per second)
    rate_limit {
        zone vllama {
            key {remote_host}
            events 10
            window 1s
        }
    }

    # Logging
    log {
        output file /var/log/caddy/vllama_access.log
        format json
    }

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
    }

    # Reverse proxy to vllama
    reverse_proxy 127.0.0.1:11434 {
        # Health checks
        health_uri /health
        health_interval 30s
        health_timeout 5s

        # Timeouts for LLM inference
        transport http {
            dial_timeout 10s
            response_header_timeout 300s
            read_timeout 300s
        }

        # Load balancing (if multiple instances)
        # lb_policy least_conn
    }

    # Optional: Basic authentication
    # Uncomment to require authentication
    # basicauth {
    #     user $2a$14$...bcrypt_hash...
    # }
}

# Optional: Metrics endpoint (Prometheus)
:9091 {
    metrics /metrics
}
